<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D SURVIVOR - CORA√á√ÉO FIX</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; user-select: none; touch-action: none; }
        .overlay { position: fixed; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; background: rgba(0,0,0,0.95); color: white; text-align: center; }
        #hud { position: absolute; top: 10px; width: 100%; display: none; justify-content: center; gap: 8px; z-index: 10; flex-wrap: wrap; }
        .box { background: rgba(0,0,0,0.8); color: #fff; padding: 8px 12px; border: 2px solid #FFD700; border-radius: 5px; font-weight: bold; font-size: 13px; }
        #inventory { position: absolute; top: 60px; display: flex; gap: 10px; z-index: 10; }
        .slot { width: 40px; height: 40px; background: rgba(255,255,255,0.1); border: 2px dashed #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .slot.active { border: 2px solid #FFD700; background: rgba(255,215,0,0.2); }
        #store-menu { position: fixed; right: -280px; top: 0; width: 240px; height: 100%; background: rgba(0,0,0,0.95); border-left: 4px solid #FF4444; z-index: 300; transition: 0.4s; padding: 20px; color: white; }
        .item-btn { width: 100%; padding: 15px; margin: 10px 0; background: #333; color: white; border: 1px solid #FFD700; cursor: pointer; font-weight: bold; border-radius: 5px; outline: none; }
        #btn-store { position: fixed; top: 20px; right: 20px; width: 55px; height: 55px; background: #FFD700; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 25px; z-index: 310; cursor: pointer; border: 3px solid #000; outline: none; }
        #mobile-ctrl { display: none; position: fixed; bottom: 30px; width: 100%; z-index: 150; pointer-events: none; }
        #joy-bg { position: absolute; left: 30px; bottom: 0; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 2px solid #FFD700; border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; left: 35px; top: 35px; width: 50px; height: 50px; background: #FFD700; border-radius: 50%; }
        #mobile-btns { position: absolute; right: 30px; bottom: 0; display: flex; gap: 15px; pointer-events: auto; }
        .m-btn { width: 75px; height: 75px; background: rgba(255,0,0,0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; border: 2px solid #FFF; }
    </style>
</head>
<body>

    <button id="btn-store" onclick="toggleStore(this)">üõí</button>

    <div id="store-menu">
        <h2 style="color:#FF4444">LOJA üõí</h2>
        <p>MOEDAS: $<span id="m-cash">0</span></p>
        <button id="buy-gun" class="item-btn" onclick="buy('gun', this)">ARMA VERMELHA ($150)</button>
        <button class="item-btn" onclick="buy('speed', this)">VELOCIDADE 5MIN ($100)</button>
        <button class="item-btn" onclick="buy('jump', this)">SUPER PULO 5MIN ($100)</button>
        <button class="item-btn" style="background:#444" onclick="toggleStore(this)">FECHAR</button>
    </div>

    <div id="screen-start" class="overlay">
        <h1 style="color:#FFD700">3D SURVIVOR</h1>
        <button class="item-btn" onclick="init('pc', this)">JOGAR PC üíª</button>
        <button class="item-btn" onclick="init('mobile', this)">JOGAR CELULAR üì±</button>
    </div>

    <div id="screen-win" class="overlay" style="display:none;">
        <h1 style="color:#FFD700">üèÜ VIT√ìRIA!</h1>
        <button class="item-btn" onclick="location.reload()">JOGAR NOVAMENTE</button>
    </div>

    <div id="hud">
        <div class="box">LVL: <span id="v-lvl">1</span></div>
        <div class="box">HP: <span id="v-hp">3</span></div>
        <div class="box">KILLS: <span id="v-kills">0</span></div>
        <div class="box" style="color:#FFD700">$: <span id="v-cash">0</span></div>
        <div id="inventory">
            <div id="slot-speed" class="slot"></div>
            <div id="slot-jump" class="slot"></div>
        </div>
    </div>

    <div id="mobile-ctrl">
        <div id="joy-bg"><div id="joy-stick"></div></div>
        <div id="mobile-btns">
            <div class="m-btn" ontouchstart="shoot()">üéØ</div>
            <div class="m-btn" ontouchstart="keys['Space']=true" ontouchend="keys['Space']=false">üöÄ</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        let gameActive = false, isMobile = false, lives = 3, kills = 0, cash = 0, level = 1;
        let pSpeed = 0.3, pJump = 0.35, hasGun = false, alienGun = false;
        let vY = 0, onGround = true, keys = {}, joyPos = {x:0, y:0}, touchX = 0, camAngle = 0;
        let aliems = [], bullets = [], platforms = [], spikes = [], worldObjects = [];

        const player = new THREE.Group();
        player.add(new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshPhongMaterial({color: 0xFFD700})));
        const gunMesh = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 1), new THREE.MeshPhongMaterial({color: 0xFF0000}));
        gunMesh.position.set(0.7, 0, -0.6); gunMesh.visible = false;
        player.add(gunMesh);
        scene.add(player);
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));

        function createLabel(text, color, scale = 3) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512; canvas.height = 128;
            ctx.fillStyle = color; ctx.font = "bold 80px Arial"; ctx.textAlign = "center";
            ctx.fillText(text, 256, 90);
            const tex = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: tex}));
            sprite.scale.set(scale, scale/4, 1); return sprite;
        }

        function createWorld() {
            worldObjects.forEach(o => scene.remove(o)); worldObjects = [];
            platforms = []; spikes = [];
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(20, 100), new THREE.MeshPhongMaterial({color: 0x228B22}));
            floor.rotation.x = -Math.PI/2; floor.position.z = -40; scene.add(floor); worldObjects.push(floor);
            const wallM = new THREE.MeshPhongMaterial({color: 0x777, transparent: true, opacity: 0.2});
            const wL = new THREE.Mesh(new THREE.BoxGeometry(1, 10, 100), wallM); wL.position.set(-10.5, 5, -40);
            const wR = new THREE.Mesh(new THREE.BoxGeometry(1, 10, 100), wallM); wR.position.set(10.5, 5, -40);
            scene.add(wL, wR); worldObjects.push(wL, wR);
            const obbyPos = [{x:0,z:15}, {x:5,z:22}, {x:-5,z:30}, {x:0,z:38}];
            obbyPos.forEach(p => {
                const plat = new THREE.Mesh(new THREE.BoxGeometry(4, 0.8, 4), new THREE.MeshPhongMaterial({color: 0x0000FF}));
                plat.position.set(p.x, 2, p.z); scene.add(plat); platforms.push(plat); worldObjects.push(plat);
            });
            const heart = new THREE.Mesh(new THREE.SphereGeometry(0.7), new THREE.MeshPhongMaterial({color: 0xFF0000}));
            heart.position.set(0, 4, 38); heart.name = "HEART";
            scene.add(heart); worldObjects.push(heart);
            for(let i=0; i< (level === 100 ? 0 : level); i++) {
                const s = new THREE.Mesh(new THREE.ConeGeometry(0.6, 1.2, 8), new THREE.MeshPhongMaterial({color: 0xFF0000}));
                s.position.set((Math.random()-0.5)*18, 0.6, -10 - Math.random()*70);
                scene.add(s); spikes.push(s); worldObjects.push(s);
            }
            const door = new THREE.Mesh(new THREE.BoxGeometry(5, 7, 1), new THREE.MeshPhongMaterial({color: 0x442200}));
            door.position.set(0, 3.5, -89); scene.add(door); worldObjects.push(door);
            aliems.forEach(a => scene.remove(a.mesh)); aliems = [];
            if(level === 100) spawnBoss(); else {
                let amount = Math.pow(2, Math.floor((level-1) / 10));
                for(let i=0; i<amount; i++) spawnAliem();
            }
        }

        function spawnAliem() {
            const g = new THREE.Group();
            g.add(new THREE.Mesh(new THREE.SphereGeometry(0.9), new THREE.MeshPhongMaterial({color: 0x00FF00})));
            const eye = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({color: 0x000}));
            const e1 = eye.clone(); e1.position.set(0.3, 0.2, 0.7);
            const e2 = eye.clone(); e2.position.set(-0.3, 0.2, 0.7);
            g.add(e1, e2);
            const name = createLabel("ALIEM", "white"); name.position.y = 2.4; g.add(name);
            const hp = createLabel("‚ô•‚ô•‚ô•", "red"); hp.position.y = 1.8; g.add(hp);
            g.position.set((Math.random()-0.5)*15, 1, -20 - Math.random()*70);
            scene.add(g); aliems.push({mesh: g, hp: 3, label: hp, isBoss: false});
        }

        function spawnBoss() {
            const g = new THREE.Group(); g.scale.set(3, 3, 3);
            g.add(new THREE.Mesh(new THREE.SphereGeometry(0.9), new THREE.MeshPhongMaterial({color: 0x006600})));
            const name = createLabel("ALIEM GIGANTE", "#FFD700", 8); name.position.y = 2.6; g.add(name);
            const hp = createLabel("‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•‚ô•", "red", 10); hp.position.y = 2.0; g.add(hp);
            g.position.set(0, 3, -50); scene.add(g); aliems.push({mesh: g, hp: 20, label: hp, isBoss: true});
        }

        function init(type, btn) {
            if(btn) btn.blur();
            isMobile = (type === 'mobile');
            document.getElementById('screen-start').style.display = 'none';
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('btn-store').style.display = 'flex';
            if(isMobile) document.getElementById('mobile-ctrl').style.display = 'block';
            createWorld(); player.position.set(0, 1, 5); gameActive = true;
        }

        function toggleStore(btn) {
            if(btn) btn.blur();
            const m = document.getElementById('store-menu');
            m.style.right = (m.style.right === '0px') ? '-280px' : '0px';
        }

        function buy(item, btn) {
            if(btn) btn.blur();
            if(item === 'gun' && cash >= 150) { 
                cash -= 150; hasGun = true; gunMesh.visible = true;
                document.getElementById('buy-gun').disabled = true;
            }
            if(item === 'speed' && cash >= 100) { 
                cash -= 100; pSpeed = 0.55; 
                document.getElementById('slot-speed').innerHTML = "‚ö°";
                document.getElementById('slot-speed').classList.add('active');
                setTimeout(() => { pSpeed = 0.3; document.getElementById('slot-speed').innerHTML = ""; document.getElementById('slot-speed').classList.remove('active'); }, 300000); 
            }
            if(item === 'jump' && cash >= 100) { 
                cash -= 100; pJump = 0.6; 
                document.getElementById('slot-jump').innerHTML = "üöÄ";
                document.getElementById('slot-jump').classList.add('active');
                setTimeout(() => { pJump = 0.35; document.getElementById('slot-jump').innerHTML = ""; document.getElementById('slot-jump').classList.remove('active'); }, 300000); 
            }
            updateUI();
        }

        function shoot() {
            if(!hasGun && !alienGun) return;
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.25), new THREE.MeshBasicMaterial({color: alienGun ? 0x00FF00 : 0xFFFF00}));
            b.position.copy(player.position);
            const dir = new THREE.Vector3(0,0,-1).applyQuaternion(player.quaternion);
            b.userData.vel = dir.multiplyScalar(1.6);
            scene.add(b); bullets.push(b);
            setTimeout(() => { scene.remove(b); bullets = bullets.filter(x => x !== b); }, 800);
        }

        function updateUI() {
            document.getElementById('v-hp').innerText = lives;
            document.getElementById('v-kills').innerText = kills;
            document.getElementById('v-cash').innerText = cash;
            document.getElementById('m-cash').innerText = cash;
            document.getElementById('v-lvl').innerText = level;
            if(kills >= 30 && !alienGun) {
                alienGun = true; gunMesh.material.color.set(0x00FF00); gunMesh.visible = true;
            }
            if(level >= 100 && aliems.length === 0) {
                gameActive = false;
                document.getElementById('screen-win').style.display = 'flex';
            }
        }

        window.addEventListener('keydown', e => { 
            keys[e.code] = true; 
            if(e.code === 'KeyF') shoot(); 
        });
        window.addEventListener('keyup', e => keys[e.code] = false);

        const jArea = document.getElementById('joy-bg');
        const jStick = document.getElementById('joy-stick');
        jArea.addEventListener('touchmove', e => {
            e.preventDefault();
            const r = jArea.getBoundingClientRect();
            const t = Array.from(e.touches).find(x => x.clientX < window.innerWidth/2);
            if(t) {
                let x = t.clientX - (r.left + 60), y = t.clientY - (r.top + 60);
                const d = Math.sqrt(x*x + y*y); if(d > 50) { x *= 50/d; y *= 50/d; }
                jStick.style.left = (x+35)+'px'; jStick.style.top = (y+35)+'px';
                joyPos = {x: x/50, y: -y/50};
            }
        });
        jArea.addEventListener('touchend', () => { joyPos = {x:0, y:0}; jStick.style.left='35px'; jStick.style.top='35px'; });
        window.addEventListener('touchstart', e => { if(e.touches[0].clientX > window.innerWidth/2) touchX = e.touches[0].clientX; });
        window.addEventListener('touchmove', e => {
            if(!isMobile) return;
            const t = e.touches[0];
            if(t.clientX > window.innerWidth/2) {
                camAngle -= (t.clientX - touchX) * 0.01;
                touchX = t.clientX;
            }
        });

        function loop() {
            requestAnimationFrame(loop);
            if(!gameActive) return;
            const fwd = new THREE.Vector3(0,0,-1).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
            const rgt = new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), camAngle);
            let mx = 0, mz = 0;
            if(isMobile) {
                mx = (rgt.x * joyPos.x + fwd.x * joyPos.y) * pSpeed;
                mz = (rgt.z * joyPos.x + fwd.z * joyPos.y) * pSpeed;
            } else {
                if(keys['KeyW']) { mx += fwd.x * pSpeed; mz += fwd.z * pSpeed; }
                if(keys['KeyS']) { mx -= fwd.x * pSpeed; mz -= fwd.z * pSpeed; }
                if(keys['KeyA']) { mx -= rgt.x * pSpeed; mz -= rgt.z * pSpeed; }
                if(keys['KeyD']) { mx += rgt.x * pSpeed; mz += rgt.z * pSpeed; }
                if(keys['ArrowLeft']) camAngle += 0.05;
                if(keys['ArrowRight']) camAngle -= 0.05;
                if(keys['Space'] && onGround) vY = pJump;
            }
            player.position.x += mx; player.position.z += mz;
            if(player.position.x > 9.5) player.position.x = 9.5; if(player.position.x < -9.5) player.position.x = -9.5;
            vY -= 0.018; player.position.y += vY;
            let grounded = false;
            if(player.position.y <= 0.6 && Math.abs(player.position.x) <= 10 && player.position.z >= -90 && player.position.z <= 10) {
                player.position.y = 0.6; vY = 0; grounded = true;
            }
            platforms.forEach(p => {
                if(Math.abs(player.position.x - p.position.x) < 2.2 && Math.abs(player.position.z - p.position.z) < 2.2 && player.position.y > p.position.y && player.position.y < p.position.y + 1.4) {
                    player.position.y = p.position.y + 1; vY = 0; grounded = true;
                }
            });
            onGround = grounded;
            if(isMobile && keys['Space'] && onGround) vY = pJump;
            if(player.position.y < -12) { lives--; player.position.set(0,5,5); updateUI(); if(lives <= 0) location.reload(); }
            if(player.position.z < -88 && level < 100) { level++; cash += 25; createWorld(); player.position.set(0,1,5); updateUI(); }
            
            // CORA√á√ÉO FIXADO AQUI
            const h = worldObjects.find(o => o.name === "HEART");
            if(h && player.position.distanceTo(h.position) < 1.5) { 
                h.name = "PEGOU"; // Trava de seguran√ßa
                lives += 3; 
                scene.remove(h); 
                updateUI(); 
            }

            spikes.forEach(s => { if(player.position.distanceTo(s.position) < 1.1) { lives--; player.position.set(0,5,5); updateUI(); } });
            aliems.forEach(a => {
                const dist = player.position.distanceTo(a.mesh.position);
                if(dist < 20) {
                    const dir = new THREE.Vector3().subVectors(player.position, a.mesh.position).normalize();
                    a.mesh.position.x += dir.x * (a.isBoss ? 0.06 : 0.12);
                    a.mesh.position.z += dir.z * (a.isBoss ? 0.06 : 0.12);
                    a.mesh.lookAt(player.position);
                }
                if(dist < (a.isBoss ? 3.5 : 1.5)) { lives--; player.position.set(0,5,5); updateUI(); }
            });
            bullets.forEach(b => {
                b.position.add(b.userData.vel);
                aliems.forEach(a => {
                    if(b.position.distanceTo(a.mesh.position) < (a.isBoss ? 4 : 1.8)) {
                        scene.remove(b); bullets = bullets.filter(x => x !== b);
                        a.hp--;
                        let hearts = ""; for(let i=0; i<a.hp; i++) hearts += "‚ô•";
                        a.mesh.remove(a.label); a.label = createLabel(hearts, "red", a.isBoss ? 10 : 3); a.label.position.y = a.isBoss ? 2 : 1.8; a.mesh.add(a.label);
                        if(a.hp <= 0) { scene.remove(a.mesh); aliems = aliems.filter(x => x !== a); kills++; cash += (a.isBoss ? 500 : 15); updateUI(); }
                    }
                });
            });
            camera.position.set(player.position.x + Math.sin(camAngle)*18, player.position.y + 10, player.position.z + Math.cos(camAngle)*18);
            camera.lookAt(player.position);
            renderer.render(scene, camera);
        }
        loop();
    </script>
</body>
</html>